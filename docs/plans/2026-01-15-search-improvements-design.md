# ะฃะปัััะตะฝะธะต ะฟะพะธัะบะฐ ะธ ัะฐะฑะพัั ั ะทะฐะฟะธััะผะธ

**ะะฐัะฐ:** 2026-01-15
**ะกัะฐััั:** ะฃัะฒะตัะถะดัะฝ

## ะัะพะฑะปะตะผั

1. **ะกะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ ะฝะต ะฝะฐัะพะดะธั ะฟะพ ัะผััะปั** โ "ะฝะตะนัะพัะตัะธ" ะฝะต ะฝะฐัะพะดะธั "llm-engineer-toolkit"
2. **"ะพัะฟัะฐะฒั ะตะต" ะฝะต ัะฐะฑะพัะฐะตั** โ ะฑะพั ะฝะต ะฟะพะฝะธะผะฐะตั ัััะปะบะธ ะฝะฐ ะฟัะตะดัะดััะธะต ัะตะทัะปััะฐัั
3. **ะกะพะดะตัะถะฐะฝะธะต ะฝะต ะฟะพะบะฐะทัะฒะฐะตััั** โ ะฟะพะธัะบ ะฒะพะทะฒัะฐัะฐะตั ัะพะปัะบะพ title ะธ score
4. **ะะฐัั ัะพััะฐะฝััััั ะบะฐะบ ัะตะบัั** โ "ะฟะพัะปะตะทะฐะฒััะฐ" ะฒะผะตััะพ ะบะพะฝะบัะตัะฝะพะน ะดะฐัั

## ะะตัะตะฝะธั

### 1. ะฃะผะฝัะน ะฟะพะธัะบ ั fallback ะฝะฐ ะฐะณะตะฝัะฐ

**ะะพะณะธะบะฐ:**
```
process_query()
    โ
hybrid_search()
    โ
โโ top_score > 0.4 โโโ ะฟะพะบะฐะทะฐัั ัะตะทัะปััะฐัั (ะบะฐะบ ัะตะนัะฐั)
โ
โโ top_score <= 0.4 ะธะปะธ ะฟัััะพ
    โ
  run_agent_loop() ั ะฟัะพะผะฟัะพะผ:
  "ะะพะธัะบ ะฟะพ ะทะฐะฟัะพัั '{query}' ะฝะต ะดะฐะป ัะพัะพัะธั ัะตะทัะปััะฐัะพะฒ.
   ะะพะฟัะพะฑัะน ะฟะตัะตัะพัะผัะปะธัะพะฒะฐัั: ัะธะฝะพะฝะธะผั, ะฐะฝะณะปะธะนัะบะธะน/ััััะบะธะน,
   ัะฒัะทะฐะฝะฝัะต ัะตัะผะธะฝั. ะัะฟะพะปัะทัะน search_items ะฝะตัะบะพะปัะบะพ ัะฐะท."
    โ
  ะะณะตะฝั ะฟัะพะฑัะตั 2-3 ะฒะฐัะธะฐะฝัะฐ ะทะฐะฟัะพัะฐ
    โ
  ะะพะทะฒัะฐัะฐะตั ะปัััะธะต ัะตะทัะปััะฐัั ะธะปะธ "ะฝะธัะตะณะพ ะฝะต ะฝะฐะนะดะตะฝะพ"
```

**ะะทะผะตะฝะตะฝะธั:**
- `src/bot/handlers/message.py` โ ะดะพะฑะฐะฒะธัั ะปะพะณะธะบั fallback ะฒ `process_query()`
- `src/ai/agent.py` โ ะดะพะฑะฐะฒะธัั ะฒ system prompt ะธะฝััััะบัะธะธ ะฟะพ ะฟะตัะตัะพัะผัะปะธัะพะฒะบะต

### 2. ะะทะฒะปะตัะตะฝะธะต ัะพะดะตัะถะฐะฝะธั ะทะฐะฟะธัะตะน

**ะะพะณะธะบะฐ ะฟะพะบะฐะทะฐ:**
```
process_query() ะฟะพัะปะต ะฟะพะปััะตะฝะธั ัะตะทัะปััะฐัะพะฒ:
    โ
โโ 1 ัะตะทัะปััะฐั โโโ ััะฐะทั ะฟะพะบะฐะทะฐัั ะฟะพะปะฝะพะต ัะพะดะตัะถะฐะฝะธะต:
โ                  "๐ {title}
โ                   {content ะธะปะธ original_input}
โ                   ะกัะพะบ: {due_at} | ะขะตะณะธ: {tags}"
โ
โโ 2+ ัะตะทัะปััะฐัะพะฒ โโโ ัะฟะธัะพะบ ั inline-ะบะฝะพะฟะบะฐะผะธ:
                      "1. ๐ Title (45%) [ะะพะบะฐะทะฐัั]
                       2. ๐ Title (38%) [ะะพะบะฐะทะฐัั]"
```

**ะะพะฝัะตะบัั ั ID ะดะปั ะฐะณะตะฝัะฐ:**
```python
message_history.add(user_id, "assistant", response, metadata={
    "search_results": [
        {"id": 120, "title": "llm-toolkit", "position": 1},
        {"id": 118, "title": "ะะตะบัะธั ะปะธะฝะตะนะบะฐ", "position": 2}
    ]
})
```

ะะณะตะฝั ะฟะพะปััะฐะตั ััะพั ะบะพะฝัะตะบัั ะธ ะฟะพะฝะธะผะฐะตั:
- "ะพัะฟัะฐะฒั ะฟะตัะฒัั" โ `get_item_details(item_id=120)`
- "ะฟะพะบะฐะถะธ ะตั" โ ะฟะพัะปะตะดะฝะธะน ัะฟะพะผัะฝัััะน item

**ะะทะผะตะฝะตะฝะธั:**
- `src/bot/handlers/message.py` โ ะปะพะณะธะบะฐ ะฟะพะบะฐะทะฐ ัะพะดะตัะถะฐะฝะธั
- `src/utils/history.py` โ ะดะพะฑะฐะฒะธัั ะฟะพะปะต metadata
- `src/bot/keyboards.py` โ ะบะฝะพะฟะบะฐ "ะะพะบะฐะทะฐัั ัะพะดะตัะถะฐะฝะธะต"
- `src/ai/agent.py` โ ะธะฝััััะบัะธะธ ะฟะพ ัะฐะฑะพัะต ั ะบะพะฝัะตะบััะพะผ

### 3. ะฃะปัััะตะฝะฝะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ะดะฐั

**ะัะพะฑัะฐะถะตะฝะธะต:**
```
ะกะพััะฐะฝะตะฝะพ: ะกัะพะดะธัั ะฒ ะผะฐะณะฐะทะธะฝ
ะกัะพะบ: ะทะฐะฒััะฐ ะบ ะดะฒัะผ (16.01.2026 14:00)
```

**ะะฟัะตะดะตะปะตะฝะธะต ะฒัะตะผะตะฝะธ ะฟะพ ะบะพะฝัะตะบััั:**
```
ะัะปะธ ะฒัะตะผั ะะ ัะบะฐะทะฐะฝะพ ัะฒะฝะพ, ะพะฟัะตะดะตะปะธ ะฟะพ ะบะพะฝัะตะบััั:
- ะฒัััะตัะฐ, ัะพะทะฒะพะฝ, ะผะธัะธะฝะณ โ 10:00
- ะพะฑะตะด โ 13:00
- ะบัะฟะธัั, ะทะฐะฑัะฐัั, ะทะฐะตัะฐัั โ 18:00
- ัะดะฐัั, ะดะตะดะปะฐะนะฝ, ะพัััั โ 23:59
- ะฝะฐะฟะพะผะฝะธ, ะฝะต ะทะฐะฑััั โ 09:00
```

**ะะทะผะตะฝะตะฝะธั:**
- `src/ai/extractor.py` โ ัะฐััะธัะธัั ะฟัะพะผะฟั ะฟัะฐะฒะธะปะฐะผะธ ะดะปั ะฒัะตะผะตะฝะธ
- `src/ai/classifier.py` โ ะฐะฝะฐะปะพะณะธัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะพะผะฟัะฐ
- `src/bot/handlers/message.py` โ ะธะทะผะตะฝะธัั ัะพัะผะฐั ะฒัะฒะพะดะฐ ะดะฐัั

## ะคะฐะนะปั ะดะปั ะธะทะผะตะฝะตะฝะธั

| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธั |
|------|-----------|
| `src/bot/handlers/message.py` | Fallback ะฝะฐ ะฐะณะตะฝัะฐ, ะฟะพะบะฐะท ัะพะดะตัะถะฐะฝะธั, ัะพัะผะฐั ะดะฐัั |
| `src/ai/agent.py` | ะะฝััััะบัะธะธ ะดะปั ะฟะพะธัะบะฐ ะธ ัะฐะฑะพัั ั ะบะพะฝัะตะบััะพะผ |
| `src/ai/extractor.py` | ะัะฐะฒะธะปะฐ ะพะฟัะตะดะตะปะตะฝะธั ะฒัะตะผะตะฝะธ ะฟะพ ะบะพะฝัะตะบััั |
| `src/ai/classifier.py` | ะัะฐะฒะธะปะฐ ะพะฟัะตะดะตะปะตะฝะธั ะฒัะตะผะตะฝะธ ะฟะพ ะบะพะฝัะตะบััั |
| `src/utils/history.py` | ะะพะปะต metadata ั ID ะทะฐะฟะธัะตะน |
| `src/bot/keyboards.py` | ะะฝะพะฟะบะฐ "ะะพะบะฐะทะฐัั ัะพะดะตัะถะฐะฝะธะต" |

## ะัะตะฝะบะฐ

~160 ัััะพะบ ะบะพะดะฐ
